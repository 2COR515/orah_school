<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>localStorage Diagnostic Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîß localStorage Diagnostic Tool</h1>
  
  <div class="test-section">
    <h2>Test 1: Check localStorage Availability</h2>
    <button onclick="testLocalStorageAvailability()">Run Test</button>
    <div id="test1-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Test Basic Read/Write</h2>
    <button onclick="testBasicReadWrite()">Run Test</button>
    <div id="test2-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Test setAuthData Function</h2>
    <button onclick="testSetAuthData()">Run Test</button>
    <div id="test3-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Simulate Login Response</h2>
    <button onclick="testLoginSimulation()">Run Test</button>
    <div id="test4-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 5: Check Current localStorage Contents</h2>
    <button onclick="showLocalStorageContents()">Show Contents</button>
    <button onclick="clearLocalStorage()" style="background: #f44336;">Clear All</button>
    <div id="test5-result"></div>
  </div>

  <script src="scripts/script.js"></script>
  <script>
    function displayResult(elementId, success, message, details = '') {
      const element = document.getElementById(elementId);
      const resultClass = success ? 'success' : 'error';
      const icon = success ? '‚úÖ' : '‚ùå';
      
      let html = `<div class="result ${resultClass}">
        <strong>${icon} ${message}</strong>
      `;
      
      if (details) {
        html += `<pre>${details}</pre>`;
      }
      
      html += '</div>';
      element.innerHTML = html;
    }

    function testLocalStorageAvailability() {
      try {
        const test = 'localStorage_test';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        displayResult('test1-result', true, 'localStorage is available and working!');
      } catch (e) {
        displayResult('test1-result', false, 'localStorage is NOT available!', 
          `Error: ${e.name}\nMessage: ${e.message}`);
      }
    }

    function testBasicReadWrite() {
      try {
        const testData = {
          string: 'Hello World',
          number: '12345',
          longString: 'x'.repeat(1000)
        };
        
        // Write
        localStorage.setItem('test_string', testData.string);
        localStorage.setItem('test_number', testData.number);
        localStorage.setItem('test_long', testData.longString);
        
        // Read
        const readString = localStorage.getItem('test_string');
        const readNumber = localStorage.getItem('test_number');
        const readLong = localStorage.getItem('test_long');
        
        // Verify
        const success = 
          readString === testData.string &&
          readNumber === testData.number &&
          readLong === testData.longString;
        
        // Cleanup
        localStorage.removeItem('test_string');
        localStorage.removeItem('test_number');
        localStorage.removeItem('test_long');
        
        if (success) {
          displayResult('test2-result', true, 'Basic read/write operations successful!',
            `‚úì String test passed\n‚úì Number test passed\n‚úì Long string test passed`);
        } else {
          displayResult('test2-result', false, 'Read/write verification failed!');
        }
      } catch (e) {
        displayResult('test2-result', false, 'Basic read/write test failed!',
          `Error: ${e.name}\nMessage: ${e.message}`);
      }
    }

    function testSetAuthData() {
      try {
        const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test';
        const mockUser = {
          userId: 'test123',
          email: 'test@test.com',
          firstName: 'Test',
          lastName: 'User',
          role: 'student'
        };
        
        console.log('Testing setAuthData with:', mockUser);
        
        // Call the actual setAuthData function from script.js
        setAuthData(mockToken, mockUser);
        
        // Verify data was stored
        const storedToken = localStorage.getItem('authToken');
        const storedRole = localStorage.getItem('userRole');
        const storedUserId = localStorage.getItem('userId');
        const storedEmail = localStorage.getItem('userEmail');
        const storedName = localStorage.getItem('userName');
        
        const success = 
          storedToken === mockToken &&
          storedRole === mockUser.role &&
          storedUserId === mockUser.userId &&
          storedEmail === mockUser.email;
        
        if (success) {
          displayResult('test3-result', true, 'setAuthData function works correctly!',
            `‚úì Token: ${storedToken.substring(0, 30)}...\n‚úì Role: ${storedRole}\n‚úì UserId: ${storedUserId}\n‚úì Email: ${storedEmail}\n‚úì Name: ${storedName}`);
        } else {
          displayResult('test3-result', false, 'setAuthData verification failed!',
            `Stored Token: ${storedToken}\nStored Role: ${storedRole}\nStored UserId: ${storedUserId}`);
        }
      } catch (e) {
        displayResult('test3-result', false, 'setAuthData function failed!',
          `Error: ${e.name}\nMessage: ${e.message}\nStack: ${e.stack}`);
      }
    }

    function testLoginSimulation() {
      const resultDiv = document.getElementById('test4-result');
      resultDiv.innerHTML = '<div class="result">Testing login endpoint...</div>';
      
      fetch('http://localhost:3001/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: 'testlogin@test.com',
          password: 'password123'
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Login response:', data);
        
        if (data.ok && data.token && data.user) {
          // Try to call setAuthData
          try {
            setAuthData(data.token, data.user);
            displayResult('test4-result', true, 'Login simulation successful!',
              `‚úì Backend responded with valid data\n‚úì setAuthData executed successfully\n‚úì Token stored in localStorage\n\nUser Info:\n${JSON.stringify(data.user, null, 2)}`);
          } catch (authError) {
            displayResult('test4-result', false, 'setAuthData failed during login simulation!',
              `Backend Response OK, but setAuthData threw error:\n${authError.message}\n\nBackend Data:\n${JSON.stringify(data, null, 2)}`);
          }
        } else {
          displayResult('test4-result', false, 'Login endpoint returned error',
            JSON.stringify(data, null, 2));
        }
      })
      .catch(error => {
        displayResult('test4-result', false, 'Login request failed!',
          `Error: ${error.message}`);
      });
    }

    function showLocalStorageContents() {
      try {
        const keys = Object.keys(localStorage);
        
        if (keys.length === 0) {
          displayResult('test5-result', true, 'localStorage is empty');
          return;
        }
        
        let contents = 'Current localStorage contents:\n\n';
        keys.forEach(key => {
          const value = localStorage.getItem(key);
          const truncated = value.length > 100 ? value.substring(0, 100) + '...' : value;
          contents += `${key}: ${truncated}\n`;
        });
        
        displayResult('test5-result', true, `Found ${keys.length} item(s) in localStorage`, contents);
      } catch (e) {
        displayResult('test5-result', false, 'Failed to read localStorage!',
          `Error: ${e.message}`);
      }
    }

    function clearLocalStorage() {
      try {
        const count = localStorage.length;
        localStorage.clear();
        displayResult('test5-result', true, `Cleared ${count} item(s) from localStorage`);
      } catch (e) {
        displayResult('test5-result', false, 'Failed to clear localStorage!',
          `Error: ${e.message}`);
      }
    }
  </script>
</body>
</html>
